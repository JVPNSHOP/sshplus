#!/bin/bash

clear

# ============================================
# SSHPLUS MANAGER INSTALLATION SCRIPT
# Compatible with: Ubuntu 20.04, 22.04, 24.04
#                 Debian 11, 12, 13
# ============================================

# Colors for output
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Check if running as root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR] This script must be run as root!${NC}"
    echo -e "${YELLOW}Use: sudo bash $0${NC}"
    exit 1
fi

# Set non-interactive mode for package installation
export DEBIAN_FRONTEND=noninteractive

# Function to print section headers
print_section() {
    echo -e "\n${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN} $1 ${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

# Function to print status
print_status() {
    if [ $? -eq 0 ]; then
        echo -e "  ${GREEN}âœ“${NC} $1"
    else
        echo -e "  ${YELLOW}âš ${NC} $1 (Skipped)"
    fi
}

# Function to check OS compatibility
check_os() {
    echo -e "${YELLOW}ðŸ” Detecting operating system...${NC}"
    
    # Check if /etc/os-release exists
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_NAME=$ID
        OS_VERSION=$VERSION_ID
        
        echo -e "${GREEN}âœ“ System: $PRETTY_NAME${NC}"
        
        # Check for supported OS
        case "$OS_NAME" in
            ubuntu)
                if [[ "$OS_VERSION" =~ ^(20\.04|22\.04|24\.04)$ ]]; then
                    echo -e "${GREEN}âœ“ Supported Ubuntu version: $OS_VERSION${NC}"
                    return 0
                else
                    echo -e "${YELLOW}âš  Unsupported Ubuntu version: $OS_VERSION${NC}"
                    echo -e "${YELLOW}Continuing anyway...${NC}"
                    return 0
                fi
                ;;
            debian)
                if [[ "$OS_VERSION" =~ ^(11|12|13)$ ]]; then
                    echo -e "${GREEN}âœ“ Supported Debian version: $OS_VERSION${NC}"
                    return 0
                else
                    echo -e "${YELLOW}âš  Unsupported Debian version: $OS_VERSION${NC}"
                    echo -e "${YELLOW}Continuing anyway...${NC}"
                    return 0
                fi
                ;;
            *)
                echo -e "${YELLOW}âš  Unknown OS: $OS_NAME${NC}"
                echo -e "${YELLOW}Continuing anyway...${NC}"
                return 0
                ;;
        esac
    else
        echo -e "${YELLOW}âš  Cannot detect OS from /etc/os-release${NC}"
        echo -e "${YELLOW}Continuing anyway...${NC}"
        return 0
    fi
}

# Function to check architecture
check_arch() {
    echo -e "${YELLOW}ðŸ” Detecting system architecture...${NC}"
    
    ARCH=$(uname -m)
    case $ARCH in
        x86_64)
            echo -e "${GREEN}âœ“ Architecture: x86_64 (64-bit)${NC}"
            ARCH_TYPE="x64"
            ;;
        aarch64|arm64)
            echo -e "${GREEN}âœ“ Architecture: ARM64${NC}"
            ARCH_TYPE="arm"
            ;;
        *)
            echo -e "${YELLOW}âš  Unknown architecture: $ARCH${NC}"
            echo -e "${YELLOW}Assuming x86_64...${NC}"
            ARCH_TYPE="x64"
            ;;
    esac
}

# Function to update system
update_system() {
    print_section "SYSTEM UPDATE"
    
    echo -e "${YELLOW}Updating package lists...${NC}"
    apt-get update -y
    print_status "Package lists updated"
    
    echo -e "${YELLOW}Upgrading installed packages...${NC}"
    apt-get upgrade -y --allow-downgrades --allow-remove-essential --allow-change-held-packages
    print_status "System upgraded"
    
    echo -e "${YELLOW}Installing essential tools...${NC}"
    apt-get install -y curl wget git sudo ufw
    print_status "Essential tools installed"
}

# Function to install required packages WITHOUT getting stuck
install_packages() {
    print_section "PACKAGE INSTALLATION"
    
    echo -e "${YELLOW}Setting up package installation...${NC}"
    
    # Pre-configure iptables-persistent to avoid interactive prompts
    echo "iptables-persistent iptables-persistent/autosave_v4 boolean true" | debconf-set-selections
    echo "iptables-persistent iptables-persistent/autosave_v6 boolean true" | debconf-set-selections
    
    # Group 1: Basic essential packages (should not have interactive prompts)
    echo -e "${YELLOW}Installing basic packages (Group 1/3)...${NC}"
    BASIC_PACKAGES=(
        "curl" "wget" "git" "sudo" "ufw" "htop" "nload" "nano" "vim"
        "screen" "tmux" "zip" "unzip" "tar" "gzip" "bzip2" "xz-utils"
        "net-tools" "dnsutils" "whois" "mlocate" "tree" "rsync" "cron"
        "logrotate" "fail2ban" "unattended-upgrades" "software-properties-common"
        "apt-transport-https" "ca-certificates" "gnupg" "lsb-release"
    )
    
    for pkg in "${BASIC_PACKAGES[@]}"; do
        echo -ne "  Installing $pkg... "
        if apt-get install -y --no-install-recommends "$pkg" > /tmp/pkg_install.log 2>&1; then
            echo -e "${GREEN}âœ“${NC}"
        else
            echo -e "${YELLOW}âš ${NC}"
        fi
    done
    
    # Group 2: Network packages (including iptables)
    echo -e "${YELLOW}Installing network packages (Group 2/3)...${NC}"
    NETWORK_PACKAGES=(
        "iptables" "iptables-persistent" "nftables" "socat" "netcat"
        "tcpdump" "nmap" "mtr" "iperf3" "openvpn" "stunnel4"
    )
    
    for pkg in "${NETWORK_PACKAGES[@]}"; do
        echo -ne "  Installing $pkg... "
        # Force non-interactive for iptables-persistent
        if [ "$pkg" = "iptables-persistent" ]; then
            if DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends "$pkg" > /tmp/iptables_install.log 2>&1; then
                echo -e "${GREEN}âœ“${NC}"
            else
                echo -e "${YELLOW}âš ${NC}"
            fi
        else
            if apt-get install -y --no-install-recommends "$pkg" > /dev/null 2>&1; then
                echo -e "${GREEN}âœ“${NC}"
            else
                echo -e "${YELLOW}âš ${NC}"
            fi
        fi
    done
    
    # Group 3: Development and other packages
    echo -e "${YELLOW}Installing development packages (Group 3/3)...${NC}"
    DEV_PACKAGES=(
        "build-essential" "python3" "python3-pip" "python3-dev" "python3-venv"
        "nodejs" "npm" "jq" "yq" "sysstat" "dstat" "iotop" "smartmontools"
        "lm-sensors" "nginx" "apache2" "certbot" "python3-certbot-nginx"
    )
    
    for pkg in "${DEV_PACKAGES[@]}"; do
        echo -ne "  Installing $pkg... "
        if apt-get install -y --no-install-recommends "$pkg" > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC}"
        else
            echo -e "${YELLOW}âš ${NC}"
        fi
    done
    
    # Install Python packages
    echo -e "${YELLOW}Installing Python packages...${NC}"
    pip3 install --upgrade pip
    pip3 install speedtest-cli flask requests beautifulsoup4
    
    echo -e "${GREEN}âœ“ Package installation completed!${NC}"
}

# Function to configure firewall
configure_firewall() {
    print_section "FIREWALL CONFIGURATION"
    
    echo -e "${YELLOW}Setting up UFW firewall...${NC}"
    
    # Disable UFW first to avoid conflicts
    ufw --force disable > /dev/null 2>&1
    ufw --force reset > /dev/null 2>&1
    
    # Set default policies
    echo "y" | ufw default deny incoming > /dev/null 2>&1
    echo "y" | ufw default allow outgoing > /dev/null 2>&1
    
    # Allow SSH first (so we don't lock ourselves out)
    ufw allow 22/tcp > /dev/null 2>&1
    
    # Allow essential ports for SSHPlus
    ESSENTIAL_PORTS=(
        "80/tcp"    # HTTP
        "443/tcp"   # HTTPS
        "53/tcp"    # DNS TCP
        "53/udp"    # DNS UDP
        "1194/tcp"  # OpenVPN
        "1194/udp"  # OpenVPN UDP
        "3128/tcp"  # Squid Proxy
        "8080/tcp"  # Web Proxy
        "8799/tcp"  # SSHPlus Panel
        "443/udp"   # QUIC/HTTP3
        "80/udp"    # HTTP UDP
    )
    
    for port in "${ESSENTIAL_PORTS[@]}"; do
        ufw allow $port > /dev/null 2>&1
    done
    
    # Enable UFW
    echo "y" | ufw enable > /dev/null 2>&1
    ufw reload > /dev/null 2>&1
    
    echo -e "${GREEN}âœ“ Firewall configured with UFW${NC}"
    
    # Show current rules
    echo -e "${YELLOW}Current firewall rules:${NC}"
    ufw status numbered | grep -E "(22|80|443|3128|8799|8080)" || echo "  No specific rules shown"
}

# Function to configure SSH
configure_ssh() {
    print_section "SSH CONFIGURATION"
    
    echo -e "${YELLOW}Backing up SSH configuration...${NC}"
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup 2>/dev/null
    
    echo -e "${YELLOW}Configuring SSH settings...${NC}"
    
    # Create a minimal sshd_config
    cat > /tmp/sshd_config_temp << EOF
# SSHPlus Manager Configuration
Port 22
Protocol 2
PermitRootLogin yes
PasswordAuthentication yes
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server
ClientAliveInterval 300
ClientAliveCountMax 2
MaxAuthTries 3
MaxSessions 10
LoginGraceTime 60
AllowTcpForwarding yes
GatewayPorts yes
AllowAgentForwarding yes
TCPKeepAlive yes
Compression yes
EOF
    
    cp /tmp/sshd_config_temp /etc/ssh/sshd_config
    
    # Restart SSH service
    systemctl restart ssh 2>/dev/null || service ssh restart 2>/dev/null
    
    echo -e "${GREEN}âœ“ SSH service configured${NC}"
}

# Function to download SSHPlus files
download_sshplus() {
    print_section "SSHPLUS MANAGER SETUP"
    
    echo -e "${YELLOW}Creating necessary directories...${NC}"
    mkdir -p /usr/local/sshplus
    mkdir -p /etc/sshplus
    mkdir -p /var/log/sshplus
    
    # Download based on architecture
    if [ "$ARCH_TYPE" = "x64" ]; then
        echo -e "${YELLOW}Downloading x86_64 version...${NC}"
        
        # Try multiple sources for the main installer
        if wget -q -O /usr/local/sshplus/installer.sh "https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/sshplus.sh"; then
            echo -e "  ${GREEN}âœ“ Main installer downloaded${NC}"
        else
            # Alternative source
            wget -q -O /usr/local/sshplus/installer.sh "https://cdn.jsdelivr.net/gh/sansoe2022/VPN_SCRIPT/Install/sshplus.sh"
            echo -e "  ${YELLOW}âš  Using alternative source${NC}"
        fi
        
        chmod +x /usr/local/sshplus/installer.sh
        
        # Download menu
        wget -q -O /usr/local/bin/menu "https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/menu.sh"
        chmod +x /usr/local/bin/menu
        
    else
        echo -e "${YELLOW}Downloading ARM version...${NC}"
        
        # Try to download ARM version
        if wget -q -O /usr/local/sshplus/installer.sh "https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/sshplus-arm.sh"; then
            echo -e "  ${GREEN}âœ“ ARM installer downloaded${NC}"
        else
            # Fallback to regular version
            wget -q -O /usr/local/sshplus/installer.sh "https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/sshplus.sh"
            echo -e "  ${YELLOW}âš  Using x86 version as fallback${NC}"
        fi
        
        chmod +x /usr/local/sshplus/installer.sh
        
        # Download menu
        wget -q -O /usr/local/bin/menu "https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/menu.sh"
        chmod +x /usr/local/bin/menu
    fi
    
    # Download common files
    echo -e "${YELLOW}Downloading common components...${NC}"
    
    # ShellBot for Telegram
    mkdir -p /root/bot
    wget -q -O /root/bot/ShellBot.sh "https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Sistema/ShellBot.sh" || \
    wget -q -O /root/bot/ShellBot.sh "https://cdn.jsdelivr.net/gh/sansoe2022/VPN_SCRIPT/Sistema/ShellBot.sh"
    chmod +x /root/bot/ShellBot.sh
    
    # Create symlinks
    ln -sf /usr/local/bin/menu /bin/menu 2>/dev/null
    ln -sf /usr/local/bin/menu /bin/h 2>/dev/null
    
    echo -e "${GREEN}âœ“ SSHPlus files downloaded${NC}"
}

# Function to create user database
create_user_db() {
    print_section "USER DATABASE SETUP"
    
    echo -e "${YELLOW}Creating user database...${NC}"
    
    # Simple user database creation
    cat > /etc/sshplus/users.db << 'EOF'
# SSHPlus User Database
# Format: username:password:expiry_date:limit
# Example: user1:pass123:2024-12-31:2
admin:admin123:2024-12-31:5
EOF
    
    # Add current non-system users
    awk -F: '$3 >= 1000 && $1 != "nobody" {print $1":changeme2024:"strftime("%Y-%m-%d", systime()+2592000)":1"}' /etc/passwd >> /etc/sshplus/users.db 2>/dev/null
    
    echo -e "${GREEN}âœ“ User database created${NC}"
}

# Function to setup monitoring
setup_monitoring() {
    print_section "MONITORING SETUP"
    
    echo -e "${YELLOW}Setting up system monitoring...${NC}"
    
    # Create simple monitoring script
    cat > /usr/local/bin/server-monitor << 'EOF'
#!/bin/bash
echo "=== SYSTEM STATUS ==="
echo "Uptime: $(uptime -p)"
echo "Load: $(cat /proc/loadavg | awk '{print $1", "$2", "$3}')"
echo "Memory: $(free -h | awk '/^Mem:/ {print $3"/"$2 " ("$4" free)"}')"
echo "Disk: $(df -h / | awk 'NR==2 {print $3"/"$2 " ("$5" used)"}')"
echo "========================="
EOF
    
    chmod +x /usr/local/bin/server-monitor
    
    echo -e "${GREEN}âœ“ Monitoring setup completed${NC}"
}

# Function to finalize installation
finalize_installation() {
    print_section "FINALIZING INSTALLATION"
    
    echo -e "${YELLOW}Cleaning up...${NC}"
    
    # Clean apt cache
    apt-get autoremove -y
    apt-get clean
    
    # Create motd banner
    cat > /etc/motd << EOF
==========================================
   SSHPLUS MANAGER - INSTALLATION COMPLETE
   OS: $(lsb_release -ds 2>/dev/null || echo "Linux")
   Date: $(date)
==========================================
Use 'menu' command to manage your server
EOF
    
    echo -e "${GREEN}âœ“ Cleanup completed${NC}"
}

# Function to show installation summary
show_summary() {
    clear
    
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}      SSHPLUS MANAGER INSTALLATION COMPLETE      ${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    echo -e "${WHITE}System Information:${NC}"
    echo -e "  OS: $(lsb_release -ds 2>/dev/null || cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d '\"')"
    echo -e "  Kernel: $(uname -r)"
    echo -e "  Architecture: $(uname -m)"
    echo -e "  IP Address: $(curl -s ifconfig.me 2>/dev/null || hostname -I 2>/dev/null | awk '{print $1}')"
    echo ""
    
    echo -e "${WHITE}Services Installed:${NC}"
    echo -e "  ${GREEN}âœ“${NC} SSH Server (Port 22)"
    echo -e "  ${GREEN}âœ“${NC} Firewall (UFW)"
    echo -e "  ${GREEN}âœ“${NC} SSHPlus Manager"
    echo -e "  ${GREEN}âœ“${NC} System Monitoring"
    echo ""
    
    echo -e "${WHITE}Ports Opened:${NC}"
    echo -e "  ${YELLOW}22${NC}   - SSH"
    echo -e "  ${YELLOW}80${NC}   - HTTP"
    echo -e "  ${YELLOW}443${NC}  - HTTPS"
    echo -e "  ${YELLOW}3128${NC} - Proxy"
    echo -e "  ${YELLOW}8799${NC} - Panel"
    echo -e "  ${YELLOW}8080${NC} - Web"
    echo ""
    
    echo -e "${WHITE}Available Commands:${NC}"
    echo -e "  ${CYAN}menu${NC}            - Main SSHPlus menu"
    echo -e "  ${CYAN}h${NC}              - Quick menu access"
    echo -e "  ${CYAN}server-monitor${NC}  - System status"
    echo ""
    
    echo -e "${WHITE}Quick Start:${NC}"
    echo -e "  1. Type ${CYAN}'menu'${NC} to open control panel"
    echo -e "  2. Create user accounts from menu"
    echo -e "  3. Check ${CYAN}'server-monitor'${NC} for system status"
    echo ""
    
    echo -e "${YELLOW}Important Notes:${NC}"
    echo -e "  â€¢ Change default passwords"
    echo -e "  â€¢ Check firewall: ${CYAN}ufw status${NC}"
    echo -e "  â€¢ SSHPlus menu: ${CYAN}menu${NC}"
    echo ""
    
    echo -e "${GREEN}âœ“ Installation completed successfully!${NC}"
    echo -e "${CYAN}For support: Telegram @SSHPLUS${NC}"
    echo -e "${YELLOW}Script by: @kiritosshxd${NC}"
    echo ""
}

# Main installation process
main() {
    # Display banner
    clear
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}       SSHPLUS MANAGER INSTALLATION SCRIPT       ${NC}"
    echo -e "${YELLOW}   Compatible: Ubuntu 20/22/24 & Debian 11/12/13 ${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Check OS compatibility
    check_os
    
    # Check architecture
    check_arch
    
    # Confirm installation
    echo -e "\n${YELLOW}This script will:${NC}"
    echo -e "  â€¢ Update system packages"
    echo -e "  â€¢ Install essential tools"
    echo -e "  â€¢ Configure firewall (ports 22,80,443,3128,8799,8080)"
    echo -e "  â€¢ Setup SSHPlus Manager"
    echo -e "  â€¢ Create user management system"
    echo ""
    read -p "Continue with installation? (y/N): " confirm
    
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        echo -e "${YELLOW}Installation cancelled.${NC}"
        exit 0
    fi
    
    # Start installation
    echo -e "\n${GREEN}Starting installation process...${NC}"
    echo -e "${YELLOW}This may take 5-10 minutes.${NC}"
    echo ""
    
    # Step 1: Update system
    update_system
    
    # Step 2: Install packages (FIXED - won't get stuck)
    install_packages
    
    # Step 3: Configure firewall
    configure_firewall
    
    # Step 4: Configure SSH
    configure_ssh
    
    # Step 5: Download SSHPlus
    download_sshplus
    
    # Step 6: Create user database
    create_user_db
    
    # Step 7: Setup monitoring
    setup_monitoring
    
    # Step 8: Finalize installation
    finalize_installation
    
    # Show summary
    show_summary
    
    # Cleanup
    rm -f /tmp/sshd_config_temp /tmp/pkg_install.log /tmp/iptables_install.log 2>/dev/null
    history -c 2>/dev/null
    
    echo -e "\n${YELLOW}You can now use the 'menu' command to manage your server.${NC}"
    echo -e "${YELLOW}A system reboot is recommended: ${WHITE}reboot${NC}\n"
}

# Run main function
main "$@"
