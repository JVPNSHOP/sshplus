#!/bin/bash
clear

#================ ROOT CHECK =================
[[ "$(id -u)" != "0" ]] && {
  echo "Run as root"
  exit 1
}

export DEBIAN_FRONTEND=noninteractive
HOME=/root

#================ OBFUSCATED VARS (KEEP) =================
_lnk=$(echo 'z1:y#x.5s0ul&p4hs$s.0a72d*n-e!v89e032:3r' | sed 's/[^a-z.]//ig' | rev)
_Ink=$(echo '/3×u3#s87r/l32o4×c1a×l1/83×l24×i0b×' | sed 's/[^a-z/]//ig')
_1nk=$(echo '/3×u3#s×87r/83×l2×4×i0b×' | sed 's/[^a-z/]//ig')
mkdir -p $_Ink

#================ LOADING BAR =================
fun_bar() {
  ( $1 >/dev/null 2>&1 ) &
  pid=$!
  echo -ne "AGUARDE ["
  while ps -p $pid >/dev/null 2>&1; do
    echo -ne "#"
    sleep 0.15
  done
  echo -e "] OK"
}

#================ KEY CHECK =================
verif_key() { [[ ! -f "$_Ink/list" ]] && { echo "KEY INVALIDA"; exit 1; } }
verif_key2(){ [[ ! -f "$_Ink/listARM" ]] && { echo "KEY INVALIDA"; exit 1; } }

#================ SSH FIX =================
fix_ssh() {
  sed -i 's/^#Port 22/Port 22/' /etc/ssh/sshd_config
  sed -i 's/^Port .*/Port 22/' /etc/ssh/sshd_config
  systemctl restart ssh || systemctl restart sshd
}

#================ PYTHON =================
fix_python() {
  apt update -y
  apt install -y python3 python3-pip python-is-python3 socat
  ln -sf /usr/bin/python3 /usr/bin/python
}

#================ PACKAGES =================
install_packages() {
  apt install -y \
    bc screen nano unzip lsof \
    net-tools dos2unix nload jq \
    curl figlet at iproute2 \
    dropbear openvpn openssl
}

#================ FIREWALL =================
fix_firewall() {
  apt install -y ufw
  ufw --force reset
  ufw default deny incoming
  ufw default allow outgoing

  for p in 22 80 443 2086 2087 1194; do
    ufw allow $p/tcp
  done
  ufw --force enable
}

#================ SSH WS 80 =================
install_ssh_ws() {
cat >/usr/local/bin/ssh-ws.py <<'EOF'
import socket,threading
L=80;T=("127.0.0.1",22)
def h(c):
 s=socket.socket();s.connect(T)
 threading.Thread(target=f,args=(c,s)).start()
 threading.Thread(target=f,args=(s,c)).start()
def f(a,b):
  try:
   while True:
    d=a.recv(4096)
    if not d:break
    b.sendall(d)
  except:pass
sock=socket.socket();sock.bind(("0.0.0.0",L));sock.listen(100)
while True:
 c,_=sock.accept()
 threading.Thread(target=h,args=(c,)).start()
EOF

chmod +x /usr/local/bin/ssh-ws.py

cat >/etc/systemd/system/ssh-ws.service <<EOF
[Unit]
After=network.target
[Service]
ExecStart=/usr/bin/python3 /usr/local/bin/ssh-ws.py
Restart=always
[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable ssh-ws
systemctl restart ssh-ws
}

#================ SSL WS 443 =================
install_ssl_ws() {
mkdir -p /etc/ssl/ws
openssl req -newkey rsa:2048 -nodes -keyout /etc/ssl/ws/key.pem \
-x509 -days 365 -out /etc/ssl/ws/cert.pem -subj "/CN=ws"

cat >/usr/local/bin/ssl-ws.py <<'EOF'
import socket,ssl,threading
L=443;T=("127.0.0.1",22)
ctx=ssl.create_default_context(ssl.Purpose.CLIENT_AUTH)
ctx.load_cert_chain("/etc/ssl/ws/cert.pem","/etc/ssl/ws/key.pem")
def h(c):
 s=socket.socket();s.connect(T)
 threading.Thread(target=f,args=(c,s)).start()
 threading.Thread(target=f,args=(s,c)).start()
def f(a,b):
  try:
   while True:
    d=a.recv(4096)
    if not d:break
    b.sendall(d)
  except:pass
sock=socket.socket();sock.bind(("0.0.0.0",L));sock.listen(100)
while True:
 c,_=sock.accept()
 sc=ctx.wrap_socket(c,server_side=True)
 threading.Thread(target=h,args=(sc,)).start()
EOF

chmod +x /usr/local/bin/ssl-ws.py

cat >/etc/systemd/system/ssl-ws.service <<EOF
[Unit]
After=network.target
[Service]
ExecStart=/usr/bin/python3 /usr/local/bin/ssl-ws.py
Restart=always
[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable ssl-ws
systemctl restart ssl-ws
}

#================ DROPBEAR WS =================
install_dropbear_ws() {
sed -i 's/NO_START=1/NO_START=0/' /etc/default/dropbear
sed -i 's/DROPBEAR_PORT=.*/DROPBEAR_PORT=109/' /etc/default/dropbear
systemctl restart dropbear

cat >/usr/local/bin/dropbear-ws.sh <<EOF
#!/bin/bash
socat TCP-LISTEN:2086,reuseaddr,fork TCP:127.0.0.1:109
EOF
chmod +x /usr/local/bin/dropbear-ws.sh

cat >/etc/systemd/system/dropbear-ws.service <<EOF
[Unit]
After=network.target
[Service]
ExecStart=/usr/local/bin/dropbear-ws.sh
Restart=always
[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable dropbear-ws
systemctl restart dropbear-ws
}

#================ OPENVPN WS =================
install_ovpn_ws() {
cat >/usr/local/bin/ovpn-ws.sh <<EOF
#!/bin/bash
socat TCP-LISTEN:2087,reuseaddr,fork TCP:127.0.0.1:1194
EOF
chmod +x /usr/local/bin/ovpn-ws.sh

cat >/etc/systemd/system/ovpn-ws.service <<EOF
[Unit]
After=network.target
[Service]
ExecStart=/usr/local/bin/ovpn-ws.sh
Restart=always
[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable ovpn-ws
systemctl restart ovpn-ws
}

#================ MENU =================
cat >/bin/menu <<'EOF'
#!/bin/bash
clear
echo "========= SSHPLUS ========="
echo "1) Port Status"
echo "2) Restart All WS"
echo "0) Exit"
read -p "Option: " op
case $op in
1) ss -tunlp ;;
2) systemctl restart ssh-ws ssl-ws dropbear-ws ovpn-ws ;;
0) exit ;;
esac
EOF
chmod +x /bin/menu

#================ START =================
fun_bar fix_ssh
fun_bar fix_firewall
fun_bar fix_python
fun_bar install_packages
fun_bar install_ssh_ws
fun_bar install_ssl_ws
fun_bar install_dropbear_ws
fun_bar install_ovpn_ws

clear
echo "INSTALL COMPLETE"
echo "SSH 22"
echo "SSH WS 80"
echo "SSL WS 443"
echo "DROPBEAR WS 2086"
echo "OPENVPN WS 2087"
echo "COMMAND: menu"
