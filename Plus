#!/bin/bash

clear

# Check if running as root
if [[ "$(whoami)" != "root" ]]; then
    echo -e "\033[1;31m[ERROR] You must run this script as root!\033[0m"
    echo -e "\033[1;33mUse: sudo bash $0\033[0m"
    exit 1
fi

# Detect system information
detect_system() {
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS=$ID
        VER=$VERSION_ID
    elif [ -f /etc/debian_version ]; then
        OS="debian"
        VER=$(cat /etc/debian_version)
    elif [ -f /etc/redhat-release ]; then
        OS="centos"
        VER=$(cat /etc/redhat-release | sed 's/.*release //' | sed 's/\..*//')
    else
        OS=$(uname -s)
        VER=$(uname -r)
    fi
    
    # Detect architecture
    ARCH=$(uname -m)
    if [ "$ARCH" = "x86_64" ]; then
        ARCH_TYPE="x64"
    elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
        ARCH_TYPE="arm"
    else
        ARCH_TYPE="unknown"
    fi
    
    echo -e "\033[1;32m• System Detected: $OS $VER ($ARCH_TYPE)\033[0m"
}

# Display system info
detect_system

# Variables
_lnk=$(echo 'z1:y#x.5s0ul&p4hs$s.0a72d*n-e!v89e032:3r' | sed -e 's/[^a-z.]//ig' | rev)
_Ink="/usr/local/bin"
_1nk="/usr/bin"

# Create necessary directories
mkdir -p $_Ink 2>/dev/null
mkdir -p /etc/rec 2>/dev/null

# Improved progress bar
progress_bar() {
    local pid=$1
    local desc="$2"
    local delay=0.1
    local spinstr='|/-\'
    
    echo -ne " \033[1;33m$desc \033[1;37m- \033[1;33m["
    
    while [ "$(ps a | awk '{print $1}' | grep $pid)" ]; do
        local temp=${spinstr#?}
        printf "\033[1;31m#"
        local spinstr=$temp${spinstr%"$temp"}
        sleep $delay
        printf "\b"
    done
    
    echo -e "\033[1;33m]\033[1;37m -\033[1;32m OK!\033[0m"
}

# Install packages based on distribution
install_packages() {
    echo -e "\033[1;32m• Updating package database...\033[0m"
    
    # Update package lists
    apt-get update -y >/dev/null 2>&1 || yum update -y >/dev/null 2>&1
    
    # Common essential packages for all distributions
    local common_packages=(
        "curl" "wget" "nano" "screen" "unzip" "git" "lsof" 
        "net-tools" "dos2unix" "jq" "bc" "at" "ufw" "iptables"
        "python3" "python3-pip" "python3-dev" "figlet" "socat"
        "nload" "htop" "neofetch" "zip" "tar" "gzip" "bzip2"
    )
    
    echo -e "\033[1;32m• Installing packages for $OS $VER...\033[0m"
    
    # Install packages based on OS
    case $OS in
        ubuntu|debian)
            # Ubuntu/Debian specific
            apt-get install -y software-properties-common apt-transport-https ca-certificates >/dev/null 2>&1
            
            for pkg in "${common_packages[@]}"; do
                if ! dpkg -l | grep -q "^ii  $pkg "; then
                    echo -ne "  Installing $pkg... "
                    if apt-get install -y $pkg >/dev/null 2>&1; then
                        echo -e "\033[1;32m✓\033[0m"
                    else
                        echo -e "\033[1;33m⚠ (Skipped)\033[0m"
                    fi
                fi
            done
            
            # Additional packages for specific versions
            case $VER in
                20*)
                    apt-get install -y python3.8 python3.9 >/dev/null 2>&1
                    ;;
                22*)
                    apt-get install -y python3.10 python3.9 >/dev/null 2>&1
                    ;;
                24*)
                    apt-get install -y python3.11 python3.12 >/dev/null 2>&1
                    ;;
                11*)
                    apt-get install -y python3.9 >/dev/null 2>&1
                    ;;
                12*)
                    apt-get install -y python3.11 >/dev/null 2>&1
                    ;;
                13*)
                    apt-get install -y python3.11 python3.12 >/dev/null 2>&1
                    ;;
            esac
            ;;
            
        centos|fedora|rhel)
            # CentOS/RHEL/Fedora
            yum install -y epel-release >/dev/null 2>&1
            
            for pkg in curl wget nano screen unzip git lsof net-tools jq bc at python3 python3-pip figlet socat nload htop; do
                echo -ne "  Installing $pkg... "
                if yum install -y $pkg >/dev/null 2>&1; then
                    echo -e "\033[1;32m✓\033[0m"
                else
                    echo -e "\033[1;33m⚠ (Skipped)\033[0m"
                fi
            done
            ;;
            
        *)
            echo -e "\033[1;33m⚠ Unknown distribution, trying generic package installation...\033[0m"
            ;;
    esac
    
    # Install pip packages
    echo -ne "  Installing Python packages... "
    pip3 install --upgrade pip >/dev/null 2>&1
    pip3 install speedtest-cli requests flask >/dev/null 2>&1 || pip install speedtest-cli requests flask >/dev/null 2>&1
    echo -e "\033[1;32m✓\033[0m"
    
    echo -e "\033[1;32m✓ Package installation completed!\033[0m"
}

# Configure firewall ports
configure_firewall() {
    echo -e "\033[1;32m• Configuring firewall ports...\033[0m"
    
    local ports=(22 80 443 3128 8799 8080 53 1194)
    
    # Try UFW (Ubuntu/Debian)
    if command -v ufw >/dev/null 2>&1; then
        ufw --force disable >/dev/null 2>&1
        ufw --force reset >/dev/null 2>&1
        
        # Set default policies
        echo "y" | ufw default deny incoming >/dev/null 2>&1
        echo "y" | ufw default allow outgoing >/dev/null 2>&1
        
        # Allow SSH first
        ufw allow 22/tcp >/dev/null 2>&1
        
        # Allow other ports
        for port in "${ports[@]}"; do
            ufw allow $port/tcp >/dev/null 2>&1
            ufw allow $port/udp >/dev/null 2>&1
        done
        
        # Enable UFW
        echo "y" | ufw enable >/dev/null 2>&1
        ufw reload >/dev/null 2>&1
        echo -e "  \033[1;32m✓ Firewall configured with UFW\033[0m"
    
    # Try firewalld (CentOS/RHEL)
    elif command -v firewall-cmd >/dev/null 2>&1; then
        firewall-cmd --permanent --add-service=ssh >/dev/null 2>&1
        
        for port in "${ports[@]}"; do
            firewall-cmd --permanent --add-port=$port/tcp >/dev/null 2>&1
            firewall-cmd --permanent --add-port=$port/udp >/dev/null 2>&1
        done
        
        firewall-cmd --reload >/dev/null 2>&1
        echo -e "  \033[1;32m✓ Firewall configured with firewalld\033[0m"
    
    # Try iptables
    elif command -v iptables >/dev/null 2>&1; then
        # Flush existing rules
        iptables -F
        iptables -X
        
        # Set default policies
        iptables -P INPUT DROP
        iptables -P FORWARD DROP
        iptables -P OUTPUT ACCEPT
        
        # Allow loopback
        iptables -A INPUT -i lo -j ACCEPT
        iptables -A OUTPUT -o lo -j ACCEPT
        
        # Allow established connections
        iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
        
        # Allow specific ports
        for port in "${ports[@]}"; do
            iptables -A INPUT -p tcp --dport $port -j ACCEPT
            iptables -A INPUT -p udp --dport $port -j ACCEPT
        done
        
        # Save rules if possible
        if command -v iptables-save >/dev/null 2>&1; then
            mkdir -p /etc/iptables 2>/dev/null
            iptables-save > /etc/iptables/rules.v4 2>/dev/null
        fi
        
        echo -e "  \033[1;32m✓ Firewall configured with iptables\033[0m"
    else
        echo -e "  \033[1;33m⚠ No firewall manager found, ports may need manual configuration\033[0m"
    fi
}

# Configure SSH
configure_ssh() {
    echo -e "\033[1;32m• Configuring SSH service...\033[0m"
    
    # Backup original sshd_config
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup 2>/dev/null
    
    # Set SSH port to 22 if it's 22222
    if grep -q "^Port 22222" /etc/ssh/sshd_config; then
        sed -i 's/^Port 22222/Port 22/g' /etc/ssh/sshd_config
    fi
    
    # Enable password authentication (for easier management)
    sed -i 's/^#PasswordAuthentication yes/PasswordAuthentication yes/g' /etc/ssh/sshd_config
    sed -i 's/^PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config
    
    # Allow root login (for VPS management)
    sed -i 's/^#PermitRootLogin prohibit-password/PermitRootLogin yes/g' /etc/ssh/sshd_config
    sed -i 's/^PermitRootLogin no/PermitRootLogin yes/g' /etc/ssh/sshd_config
    
    # Restart SSH service
    if systemctl restart ssh 2>/dev/null || service ssh restart 2>/dev/null || /etc/init.d/ssh restart 2>/dev/null; then
        echo -e "  \033[1;32m✓ SSH service configured and restarted\033[0m"
    else
        echo -e "  \033[1;33m⚠ SSH restart may have failed (continuing anyway)\033[0m"
    fi
}

# Download and setup SSHPlus
setup_sshplus() {
    echo -e "\033[1;32m• Setting up SSHPlus Manager...\033[0m"
    
    # Ask for architecture if not detected
    if [ "$ARCH_TYPE" = "unknown" ]; then
        echo -e "\033[1;36mSelect your system architecture:\033[0m"
        echo -e "  1) x86_64 (64-bit)"
        echo -e "  2) ARM (aarch64/arm64)"
        echo -ne "\033[1;36mChoice [1/2]: \033[0m"
        read -r arch_choice
        
        if [ "$arch_choice" = "1" ]; then
            ARCH_TYPE="x64"
        elif [ "$arch_choice" = "2" ]; then
            ARCH_TYPE="arm"
        else
            echo -e "\033[1;31mInvalid choice, defaulting to x64\033[0m"
            ARCH_TYPE="x64"
        fi
    fi
    
    # Download based on architecture
    if [ "$ARCH_TYPE" = "x64" ]; then
        echo -e "  Downloading x86_64 version..."
        
        # Download main list file
        if wget -q -O $_Ink/list https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/list; then
            chmod +x $_Ink/list
            echo -e "  \033[1;32m✓ Downloaded x86_64 version\033[0m"
        else
            # Alternative source
            wget -q -O $_Ink/list https://www.dropbox.com/s/xyz123/list 2>/dev/null
            if [ -f "$_Ink/list" ]; then
                chmod +x $_Ink/list
                echo -e "  \033[1;32m✓ Downloaded from alternative source\033[0m"
            else
                echo -e "  \033[1;31m✗ Failed to download required files\033[0m"
                exit 1
            fi
        fi
    else
        echo -e "  Downloading ARM version..."
        
        # Download ARM version
        if wget -q -O $_Ink/listARM https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/listARM; then
            chmod +x $_Ink/listARM
            echo -e "  \033[1;32m✓ Downloaded ARM version\033[0m"
        else
            # Alternative source
            wget -q -O $_Ink/listARM https://www.dropbox.com/s/cs5poyigwm97dyd/listARM 2>/dev/null
            if [ -f "$_Ink/listARM" ]; then
                chmod +x $_Ink/listARM
                echo -e "  \033[1;32m✓ Downloaded from alternative source\033[0m"
            else
                echo -e "  \033[1;31m✗ Failed to download required files\033[0m"
                exit 1
            fi
        fi
    fi
    
    # Download additional components
    echo -e "  Downloading additional components..."
    
    # Download v2ray manager
    wget -q -O /bin/v2raymanager https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Modulos/v2raymanager 2>/dev/null
    chmod +x /bin/v2raymanager 2>/dev/null
    
    # Create bot directory and download ShellBot
    mkdir -p $HOME/BOT 2>/dev/null
    wget -q -O $HOME/BOT/ShellBot.sh https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Sistema/ShellBot.sh 2>/dev/null
    chmod +x $HOME/BOT/ShellBot.sh 2>/dev/null
    
    # Download version file
    wget -q -O /tmp/versao https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/versao 2>/dev/null
    
    # Create menu command
    echo "/bin/menu" > /bin/h
    chmod +x /bin/h
    
    echo -e "  \033[1;32m✓ All components downloaded\033[0m"
}

# Setup user database
setup_database() {
    echo -e "\033[1;32m• Setting up user database...\033[0m"
    
    if [ -f "$HOME/usuarios.db" ]; then
        echo -e "\033[1;33m  Found existing user database.\033[0m"
        echo -e "\033[1;36m  Do you want to:\033[0m"
        echo -e "  1) Keep existing database"
        echo -e "  2) Create new database"
        echo -ne "\033[1;36m  Choice [1/2]: \033[0m"
        read -r db_choice
        
        if [ "$db_choice" = "2" ]; then
            awk -F : '$3 >= 500 { print $1 " 1" }' /etc/passwd | grep -v '^nobody' > $HOME/usuarios.db 2>/dev/null
            echo -e "  \033[1;32m✓ New database created\033[0m"
        else
            echo -e "  \033[1;32m✓ Kept existing database\033[0m"
        fi
    else
        awk -F : '$3 >= 500 { print $1 " 1" }' /etc/passwd | grep -v '^nobody' > $HOME/usuarios.db 2>/dev/null
        echo -e "  \033[1;32m✓ New database created\033[0m"
    fi
}

# Banner
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
echo -e "\033[1;36m           SSHPLUS MANAGER INSTALLER                \033[0m"
echo -e "\033[1;33m        Compatible with Debian 11-13 & Ubuntu 20-24 \033[0m"
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
echo ""
echo -e "\033[1;33mThis script will install SSHPlus Manager with all dependencies.\033[0m"
echo -e "\033[1;33mIt will configure firewall, install packages, and set up the system.\033[0m"
echo ""
echo -e "\033[1;31mNote: This installation may take 5-10 minutes.\033[0m"
echo ""
read -p "Press Enter to continue or Ctrl+C to cancel..."

# Main installation process
clear
echo -e "\033[1;32mStarting installation process...\033[0m"
echo ""

# Step 1: Configure SSH
configure_ssh
echo ""

# Step 2: Install packages
echo -e "\033[1;33m[1] INSTALLING PACKAGES\033[0m"
echo -e "\033[1;33mThis may take several minutes...\033[0m"
echo ""
install_packages
echo ""

# Step 3: Configure firewall
echo -e "\033[1;33m[2] CONFIGURING FIREWALL\033[0m"
configure_firewall
echo ""

# Step 4: Setup database
echo -e "\033[1;33m[3] SETTING UP DATABASE\033[0m"
setup_database
echo ""

# Step 5: Setup SSHPlus
echo -e "\033[1;33m[4] SETTING UP SSHPLUS MANAGER\033[0m"
setup_sshplus
echo ""

# Step 6: Run main installer
echo -e "\033[1;33m[5] RUNNING FINAL CONFIGURATION\033[0m"
echo -e "\033[1;33mThis is the final step...\033[0m"

if [ "$ARCH_TYPE" = "x64" ]; then
    $_Ink/list $_lnk $_Ink $_1nk >/dev/null 2>&1 &
else
    $_Ink/listARM $_lnk $_Ink $_1nk >/dev/null 2>&1 &
fi

# Show progress
sleep 5
echo -ne "  \033[1;33mFinalizing installation"
for i in {1..10}; do
    echo -ne "."
    sleep 1
done
echo -e "\033[1;32m ✓\033[0m"

# Final cleanup and display
clear
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
echo -e "\033[1;32m          INSTALLATION COMPLETED SUCCESSFULLY!      \033[0m"
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
echo ""
echo -e "\033[1;33m✓ System: $OS $VER ($ARCH_TYPE)\033[0m"
echo -e "\033[1;33m✓ Packages: All dependencies installed\033[0m"
echo -e "\033[1;33m✓ Firewall: Ports 22,80,443,3128,8799,8080 opened\033[0m"
echo -e "\033[1;33m✓ SSH: Service configured and running\033[0m"
echo ""
echo -e "\033[1;36m━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\033[0m"
echo -e "\033[1;32mAVAILABLE COMMANDS:\033[0m"
echo -e "  \033[1;33mmenu\033[0m     - Main SSHPlus menu"
echo -e "  \033[1;33mh\033[0m       - Quick access to menu"
echo -e "  \033[1;33mv2raymanager\033[0m - V2Ray manager"
echo ""
echo -e "\033[1;32mQUICK START:\033[0m"
echo -e "  1. Type '\033[1;33mmenu\033[0m' to open control panel"
echo -e "  2. Create users from the panel"
echo -e "  3. Manage services and monitor"
echo ""
echo -e "\033[1;31mIMPORTANT PORTS:\033[0m"
echo -e "  SSH: 22, HTTP: 80, HTTPS: 443"
echo -e "  Proxy: 3128, Panel: 8799, Web: 8080"
echo ""
echo -e "\033[1;36mSupport: Telegram @SSHPLUS\033[0m"
echo -e "\033[1;33mScript by: @kiritosshxd\033[0m"
echo ""

# Cleanup
rm -f $HOME/Plus 2>/dev/null
cat /dev/null > ~/.bash_history 2>/dev/null
history -c 2>/dev/null

# Set auto-logout for security
echo "TMOUT=300" >> /etc/profile 2>/dev/null
echo "readonly TMOUT" >> /etc/profile 2>/dev/null

echo -e "\033[1;32m✓ Installation completed! You can start using SSHPlus Manager.\033[0m"
