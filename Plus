#!/bin/bash

# ==============================================
# SSHPLUS MANAGER - Ubuntu 22.04/24.04 Fix
# ==============================================

clear
echo -e "\033[1;33m"
cat << "EOF"
   _____ _____ _    _ _    _ ____  
  / ____|  __ \ |  | | |  | |  _ \ 
 | (___ | |__) | |__| | |  | | |_) |
  \___ \|  ___/|  __  | |  | |  _ < 
  ____) | |    | |  | | |__| | |_) |
 |_____/|_|    |_|  |_|\____/|____/ 
                                    
EOF
echo -e "\033[0m"

# ==============================================
# ROOT CHECK
# ==============================================
if [[ $EUID -ne 0 ]]; then
    echo -e "\033[1;31m‚úó ERROR: This script must be run as root!\033[0m"
    echo -e "\033[1;33mUse: sudo bash script.sh\033[0m"
    exit 1
fi

# ==============================================
# SYSTEM DETECTION
# ==============================================
OS_ID=$(grep ^ID= /etc/os-release | cut -d= -f2 | tr -d '"')
OS_VERSION=$(grep VERSION_ID /etc/os-release | cut -d= -f2 | tr -d '"' | cut -d. -f1)
ARCH=$(uname -m)

echo -e "\033[1;36m‚úì System Detected: $OS_ID $OS_VERSION ($ARCH)\033[0m"

# ==============================================
# CONFIGURATION
# ==============================================
export DEBIAN_FRONTEND=noninteractive
HOME="/root"
INSTALL_DIR="/etc/sshplus"
LOG_FILE="/var/log/sshplus_install.log"
REPO_URL="https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main"

# ==============================================
# COLOR FUNCTIONS
# ==============================================
red() { echo -e "\033[1;31m$1\033[0m"; }
green() { echo -e "\033[1;32m$1\033[0m"; }
yellow() { echo -e "\033[1;33m$1\033[0m"; }
blue() { echo -e "\033[1;34m$1\033[0m"; }
magenta() { echo -e "\033[1;35m$1\033[0m"; }
cyan() { echo -e "\033[1;36m$1\033[0m"; }

# ==============================================
# PROGRESS BAR
# ==============================================
progress_bar() {
    local duration=$1
    local increment=$((100/$duration))
    for ((i=0; i<=100; i+=$increment)); do
        echo -ne "\r["
        for ((j=0; j<i; j+=2)); do echo -ne "#"; done
        for ((j=i; j<100; j+=2)); do echo -ne "."; done
        echo -ne "] $i%"
        sleep 0.1
    done
    echo -ne "\r["
    for ((j=0; j<100; j+=2)); do echo -ne "#"; done
    echo -ne "] 100%"
    echo
}

# ==============================================
# LOGGING
# ==============================================
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> $LOG_FILE
    echo -e "$1"
}

# ==============================================
# INSTALLATION STEPS
# ==============================================

# Step 1: System Preparation
system_prepare() {
    log "‚è≥ Preparing system..."
    
    # Update system
    apt-get update -y >> $LOG_FILE 2>&1
    apt-get upgrade -y >> $LOG_FILE 2>&1
    
    # Install essential tools
    apt-get install -y \
        curl wget git sudo ufw systemd \
        software-properties-common apt-transport-https \
        ca-certificates gnupg lsb-release >> $LOG_FILE 2>&1
    
    # Add universe repository for Ubuntu
    add-apt-repository universe -y >> $LOG_FILE 2>&1
    apt-get update -y >> $LOG_FILE 2>&1
    
    green "‚úì System prepared"
}

# Step 2: Install Python
install_python() {
    log "‚è≥ Installing Python..."
    
    # Remove old Python if exists
    apt-get remove --purge -y python2* python3.6* >> $LOG_FILE 2>&1
    
    # Install Python 3.8-3.11
    apt-get install -y \
        python3 python3-pip python3-dev \
        python3.8 python3.8-dev \
        python3.9 python3.9-dev \
        python3.10 python3.10-dev \
        python3.11 python3.11-dev \
        python3-venv python3-full >> $LOG_FILE 2>&1
    
    # Set Python 3.10 as default
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1 >> $LOG_FILE 2>&1
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 2 >> $LOG_FILE 2>&1
    update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.8 3 >> $LOG_FILE 2>&1
    update-alternatives --set python3 /usr/bin/python3.10 >> $LOG_FILE 2>&1
    
    # Install pip packages
    pip3 install --upgrade pip >> $LOG_FILE 2>&1
    pip3 install speedtest-cli requests flask >> $LOG_FILE 2>&1
    
    # Create symlinks
    ln -sf /usr/bin/python3 /usr/bin/python >> $LOG_FILE 2>&1
    
    green "‚úì Python installed"
}

# Step 3: Install Required Packages
install_packages() {
    log "‚è≥ Installing required packages..."
    
    # Essential packages
    essential_packages=(
        bc screen nano unzip lsof net-tools
        dos2unix nload jq curl wget git
        figlet at htop iotop iftop
        build-essential libssl-dev libffi-dev
        gcc make perl zip unzip p7zip
        dnsutils netcat-openbsd telnet
        ssh openssh-server openssh-client
        socat stunnel4 dropbear squid
        openvpn easy-rsa
        python3-pip python3-venv python3-dev
        software-properties-common
        apt-transport-https ca-certificates
        gnupg lsb-release
    )
    
    for pkg in "${essential_packages[@]}"; do
        apt-get install -y "$pkg" >> $LOG_FILE 2>&1
    done
    
    # Install specific versions for Ubuntu 22/24
    if [[ $OS_VERSION -ge 22 ]]; then
        apt-get install -y \
            iptables-persistent \
            netfilter-persistent \
            libnss3-tools \
            libxml2-dev \
            libxslt1-dev \
            zlib1g-dev >> $LOG_FILE 2>&1
    fi
    
    green "‚úì Packages installed"
}

# Step 4: Configure Firewall
configure_firewall() {
    log "‚è≥ Configuring firewall..."
    
    # Disable and reset UFW
    ufw --force disable >> $LOG_FILE 2>&1
    ufw --force reset >> $LOG_FILE 2>&1
    
    # Clear iptables
    iptables -F
    iptables -X
    iptables -t nat -F
    iptables -t nat -X
    iptables -t mangle -F
    iptables -t mangle -X
    iptables -P INPUT ACCEPT
    iptables -P FORWARD ACCEPT
    iptables -P OUTPUT ACCEPT
    
    # Enable UFW
    ufw --force enable >> $LOG_FILE 2>&1
    
    # Open essential ports
    declare -a ports=(
        22      # SSH
        80      # HTTP
        443     # HTTPS
        1080    # SOCKS
        1081    # SOCKS
        1082    # SOCKS
        3128    # Squid
        8080    # Proxy
        8081    # Proxy
        8082    # Proxy
        8799    # Custom
        8888    # Custom
        9000    # Custom
        53      # DNS
        1194    # OpenVPN
        444     # SSL
        7777    # Custom
    )
    
    for port in "${ports[@]}"; do
        ufw allow $port/tcp >> $LOG_FILE 2>&1
        ufw allow $port/udp >> $LOG_FILE 2>&1
    done
    
    # Allow all from localhost
    ufw allow from 127.0.0.1 >> $LOG_FILE 2>&1
    
    # Enable logging
    ufw logging on >> $LOG_FILE 2>&1
    ufw reload >> $LOG_FILE 2>&1
    
    # Save iptables rules
    if command -v iptables-save > /dev/null; then
        iptables-save > /etc/iptables/rules.v4
    fi
    
    green "‚úì Firewall configured"
}

# Step 5: Install SSHPLUS Manager
install_sshplus() {
    log "‚è≥ Installing SSHPLUS Manager..."
    
    # Create directories
    mkdir -p $INSTALL_DIR
    mkdir -p /usr/share/sshplus
    mkdir -p /etc/rec
    
    # Download main script
    cd $HOME
    rm -f Plus >> $LOG_FILE 2>&1
    wget -O Plus $REPO_URL/Install/Plus >> $LOG_FILE 2>&1
    chmod +x Plus >> $LOG_FILE 2>&1
    
    # Create menu command
    cat > /bin/menu << EOF
#!/bin/bash
cd /etc/sshplus
bash menu.sh
EOF
    chmod +x /bin/menu
    
    # Create h command
    echo "/bin/menu" > /bin/h
    chmod +x /bin/h
    
    # Download menu script
    wget -O $INSTALL_DIR/menu.sh $REPO_URL/Install/menu >> $LOG_FILE 2>&1
    chmod +x $INSTALL_DIR/menu.sh
    
    # Download additional modules
    cd /bin
    wget -O v2raymanager $REPO_URL/Modulos/v2raymanager >> $LOG_FILE 2>&1
    wget -O botteste.sh https://www.dropbox.com/s/m9tnme1jjbnehnj/botteste.sh >> $LOG_FILE 2>&1
    chmod +x v2raymanager botteste.sh
    
    # Create bot directory
    mkdir -p $HOME/BOT
    cd $HOME/BOT
    wget -O ShellBot.sh $REPO_URL/Sistema/ShellBot.sh >> $LOG_FILE 2>&1
    chmod +x ShellBot.sh
    
    # Download version file
    cd $HOME
    wget -O versao $REPO_URL/Install/versao >> $LOG_FILE 2>&1
    
    # Create user database if not exists
    if [[ ! -f $HOME/usuarios.db ]]; then
        awk -F : '$3 >= 500 { print $1 " 1" }' /etc/passwd | grep -v '^nobody' > $HOME/usuarios.db
    fi
    
    green "‚úì SSHPLUS Manager installed"
}

# Step 6: Configure Services
configure_services() {
    log "‚è≥ Configuring services..."
    
    # SSH Configuration
    sed -i 's/#Port 22/Port 22/g' /etc/ssh/sshd_config
    sed -i 's/Port 22222/Port 22/g' /etc/ssh/sshd_config
    systemctl restart ssh
    
    # Squid Configuration
    cat > /etc/squid/squid.conf << EOF
http_port 3128
http_port 8080
http_port 8000
visible_hostname sshplus
cache_dir ufs /var/spool/squid 100 16 256
cache_mem 256 MB
maximum_object_size 1024 MB
dns_nameservers 8.8.8.8 8.8.4.4
access_log none
cache_log /dev/null
cache_store_log /dev/null
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern ^gopher:        1440    0%      1440
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
acl localnet src 0.0.0.0/0
http_access allow localnet
http_access allow all
EOF
    
    # Dropbear Configuration
    echo "NO_START=0" > /etc/default/dropbear
    echo 'DROPBEAR_PORT=443' >> /etc/default/dropbear
    echo 'DROPBEAR_EXTRA_ARGS="-p 444 -p 7777"' >> /etc/default/dropbear
    
    # Stunnel Configuration
    cat > /etc/stunnel/stunnel.conf << EOF
cert = /etc/stunnel/stunnel.pem
client = no
socket = a:SO_REUSEADDR=1
socket = l:TCP_NODELAY=1
socket = r:TCP_NODELAY=1

[dropbear]
accept = 445
connect = 127.0.0.1:443

[openssh]
accept = 444
connect = 127.0.0.1:22

[squid]
accept = 3129
connect = 127.0.0.1:3128
EOF
    
    # Create SSL certificate for stunnel
    openssl req -new -x509 -days 365 -nodes \
        -out /etc/stunnel/stunnel.pem \
        -keyout /etc/stunnel/stunnel.pem \
        -subj "/C=US/ST=California/L=Los Angeles/O=SSHPLUS/CN=sshplus.com" >> $LOG_FILE 2>&1
    
    # Enable and restart services
    systemctl enable squid >> $LOG_FILE 2>&1
    systemctl enable dropbear >> $LOG_FILE 2>&1
    systemctl enable stunnel4 >> $LOG_FILE 2>&1
    
    systemctl restart squid >> $LOG_FILE 2>&1
    systemctl restart dropbear >> $LOG_FILE 2>&1
    systemctl restart stunnel4 >> $LOG_FILE 2>&1
    
    green "‚úì Services configured"
}

# Step 7: Fix Permissions
fix_permissions() {
    log "‚è≥ Fixing permissions..."
    
    # Set proper permissions
    chmod 755 /bin/menu
    chmod 755 /bin/h
    chmod 755 $INSTALL_DIR/menu.sh
    chmod 755 /bin/v2raymanager
    chmod 755 /bin/botteste.sh
    chmod 755 $HOME/BOT/ShellBot.sh
    
    # Create .plus directory
    mkdir -p /usr/share/.plus
    echo "crz: $(date)" > /usr/share/.plus/.plus
    
    # Fix SSH permissions
    chmod 700 /root/.ssh 2>/dev/null
    chmod 600 /root/.ssh/authorized_keys 2>/dev/null
    
    green "‚úì Permissions fixed"
}

# Step 8: Create SOCKS Proxy Script
create_socks_script() {
    log "‚è≥ Creating SOCKS proxy scripts..."
    
    # SOCKS SSH script
    cat > /usr/local/bin/socks-ssh << 'EOF'
#!/bin/bash
PORT=${1:-1080}
USER=${2:-sshplus}
while true; do
    echo "Starting SOCKS SSH on port $PORT"
    sshpass -p "$USER" ssh -o StrictHostKeyChecking=no \
        -o ServerAliveInterval=60 \
        -D 0.0.0.0:$PORT \
        -N $USER@localhost
    sleep 5
done
EOF
    
    # WebSocket script
    cat > /usr/local/bin/websocket << 'EOF'
#!/bin/bash
PORT=${1:-8888}
while true; do
    echo "Starting WebSocket on port $PORT"
    wsserver --port $PORT --ssl-cert /etc/stunnel/stunnel.pem
    sleep 5
done
EOF
    
    # Port opener script
    cat > /usr/local/bin/open-port << 'EOF'
#!/bin/bash
if [[ -z "$1" ]]; then
    echo "Usage: open-port <port>"
    exit 1
fi
PORT=$1
ufw allow $PORT/tcp
iptables -A INPUT -p tcp --dport $PORT -j ACCEPT
echo "Port $PORT opened"
EOF
    
    chmod +x /usr/local/bin/socks-ssh
    chmod +x /usr/local/bin/websocket
    chmod +x /usr/local/bin/open-port
    
    green "‚úì SOCKS scripts created"
}

# Step 9: Create Systemd Services
create_services() {
    log "‚è≥ Creating systemd services..."
    
    # SOCKS Service
    cat > /etc/systemd/system/socks.service << EOF
[Unit]
Description=SOCKS Proxy Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/socks-ssh 1080
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
    
    # WebSocket Service
    cat > /etc/systemd/system/websocket.service << EOF
[Unit]
Description=WebSocket Service
After=network.target

[Service]
Type=simple
User=root
ExecStart=/usr/local/bin/websocket 8888
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF
    
    # Reload systemd
    systemctl daemon-reload
    
    # Enable services
    systemctl enable socks.service >> $LOG_FILE 2>&1
    systemctl enable websocket.service >> $LOG_FILE 2>&1
    
    green "‚úì Systemd services created"
}

# Step 10: Final Configuration
final_configuration() {
    log "‚è≥ Final configuration..."
    
    # Create test script
    cat > /root/test-ports.sh << 'EOF'
#!/bin/bash
echo "Testing open ports..."
for port in 22 80 443 1080 3128 8080 8799; do
    if timeout 2 bash -c "echo > /dev/tcp/127.0.0.1/$port" 2>/dev/null; then
        echo -e "Port $port: \033[1;32mOPEN\033[0m"
    else
        echo -e "Port $port: \033[1;31mCLOSED\033[0m"
    fi
done
EOF
    chmod +x /root/test-ports.sh
    
    # Create fix script
    cat > /root/fix-all.sh << 'EOF'
#!/bin/bash
# Fix all SSHPLUS issues
systemctl restart ssh
systemctl restart squid
systemctl restart dropbear
systemctl restart stunnel4
systemctl restart socks.service
systemctl restart websocket.service
ufw --force disable
ufw --force enable
ufw reload
iptables -F
iptables -X
for port in 22 80 443 1080 3128 8080 8799; do
    ufw allow $port/tcp
done
echo "All services restarted and ports opened"
EOF
    chmod +x /root/fix-all.sh
    
    # Clean bash history
    cat /dev/null > ~/.bash_history
    history -c
    
    green "‚úì Final configuration completed"
}

# ==============================================
# MAIN INSTALLATION FUNCTION
# ==============================================
main_installation() {
    clear
    echo -e "\033[1;36m"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë    SSHPLUS MANAGER INSTALLATION      ‚ïë"
    echo "‚ïë      Ubuntu 22.04/24.04 Fix         ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "\033[0m"
    
    # Execute all steps
    steps=(
        "system_prepare"
        "install_python"
        "install_packages"
        "configure_firewall"
        "install_sshplus"
        "configure_services"
        "fix_permissions"
        "create_socks_script"
        "create_services"
        "final_configuration"
    )
    
    for step in "${steps[@]}"; do
        $step
        progress_bar 2
    done
    
    # Installation complete
    clear
    echo -e "\033[1;32m"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë     INSTALLATION COMPLETE!          ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "\033[0m"
    
    echo ""
    echo -e "\033[1;33müì¶ Installation Summary:\033[0m"
    echo -e "  ‚úì System: Ubuntu $OS_VERSION ($ARCH)"
    echo -e "  ‚úì Python: $(python3 --version 2>/dev/null || echo 'Not found')"
    echo -e "  ‚úì Firewall: Configured with all ports open"
    echo -e "  ‚úì SSHPLUS: Installed in $INSTALL_DIR"
    echo ""
    echo -e "\033[1;33müöÄ Available Commands:\033[0m"
    echo -e "  ‚Ä¢ \033[1;32mmenu\033[0m - Main SSHPLUS menu"
    echo -e "  ‚Ä¢ \033[1;32mtest-ports.sh\033[0m - Test all ports"
    echo -e "  ‚Ä¢ \033[1;32mfix-all.sh\033[0m - Fix all issues"
    echo ""
    echo -e "\033[1;33müîß Open Ports:\033[0m"
    echo -e "  SSH: 22, 443, 444"
    echo -e "  SOCKS: 1080, 1081, 1082"
    echo -e "  HTTP: 80, 3128, 8080"
    echo -e "  Custom: 8799, 8888, 9000"
    echo ""
    echo -e "\033[1;33m‚ö†Ô∏è  Important:\033[0m"
    echo -e "  1. Reboot your server: \033[1;32mreboot\033[0m"
    echo -e "  2. After reboot, type: \033[1;32mmenu\033[0m"
    echo -e "  3. Test ports: \033[1;32mbash test-ports.sh\033[0m"
    echo ""
    echo -e "\033[1;36mLog file: $LOG_FILE\033[0m"
    echo ""
    
    # Ask for reboot
    read -p "Reboot now? (y/n): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
        reboot
    fi
}

# ==============================================
# START INSTALLATION
# ==============================================
main_installation
