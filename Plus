#!/bin/bash
clear

# Check if user is root
[[ "$(whoami)" != "root" ]] && { 
    echo -e "\033[1;33m[\033[1;31mError\033[1;33m] \033[1;37m- \033[1;33mYou must run this script as root\033[0m"
    exit 1 
}

# De-obfuscating paths (keeping your original logic)
_lnk=$(echo 'z1:y#x.5s0ul&p4hs$s.0a72d*n-e!v89e032:3r' | sed -e 's/[^a-z.]//ig' | rev)
_Ink=$(echo '/3×u3#s87r/l32o4×c1a×l1/83×l24×i0b×' | sed -e 's/[^a-z/]//ig')
_1nk=$(echo '/3×u3#s×87r/83×l2×4×i0b×' | sed -e 's/[^a-z/]//ig')

cd $HOME

# Progress Bar Function
fun_bar() {
    comando[0]="$1"
    comando[1]="$2"
    (
        [[ -e $HOME/fim ]] && rm $HOME/fim
        ${comando[0]} -y >/dev/null 2>&1
        ${comando[1]} -y >/dev/null 2>&1
        touch $HOME/fim
    ) >/dev/null 2>&1 &
    tput civis
    echo -ne " \033[1;33mWAITING \033[1;37m- \033[1;33m["
    while true; do
        for ((i = 0; i < 18; i++)); do
            echo -ne "\033[1;31m#"
            sleep 0.1s
        done
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
        echo -e "\033[1;33m]"
        sleep 1s
        tput cuu1
        tput dl1
        echo -ne " \033[1;33mWAITING \033[1;37m- \033[1;33m["
    done
    echo -e "\033[1;33m]\033[1;37m -\033[1;32m OK !\033[1;37m"
    tput cnorm
}

# Key Verification Functions
function verif_key() {
    chmod +x $_Ink/list >/dev/null 2>&1
    [[ ! -e "$_Ink/list" ]] && { 
        echo -e "\n\033[1;31mINVALID KEY!\033[0m"
        exit 1 
    }
}

function verif_key2() {
    chmod +x $_Ink/listARM >/dev/null 2>&1
    [[ ! -e "$_Ink/listARM" ]] && { 
        echo -e "\n\033[1;31mINVALID KEY!\033[0m"
        exit 1 
    }
}

# Improved Python Optimization for Ubuntu 22/24 and Debian 11/12
otimize_python() {
    apt-get install python3 python3-pip socat -y >/dev/null 2>&1
    # Modern systems use python3 as default
    if [[ ! -f /usr/bin/python ]]; then
        ln -s /usr/bin/python3 /usr/bin/python >/dev/null 2>&1
    fi
}

echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
tput setaf 7; tput setab 4; tput bold
printf '%40s%s%-12s\n' "WELCOME TO SSHPLUS MANAGER"
tput sgr0
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
echo ""
echo -e " \033[1;31mATTENTION! \033[1;33mTHIS SCRIPT WILL:\033[0m"
echo ""
echo -e "\033[1;31m• \033[1;33mINSTALL A SET OF SCRIPTS AND TOOLS\033[0m"
echo -e "\033[1;33m FOR NETWORK, SYSTEM, AND USER MANAGEMENT\033[0m"
echo ""
echo -e "\033[1;32m• \033[1;32mTIP! \033[1;33mUSE DARK THEME IN YOUR TERMINAL FOR\033[0m"
echo -e "\033[1;33m A BETTER VISUAL EXPERIENCE!\033[0m"
echo ""
echo -e "\033[1;31m≠×≠×≠×≠×≠×≠×≠×[\033[1;33m • \033[1;32mMOD BY: @kirito_ssh \033[1;33m •\033[1;31m ]≠×≠×≠×≠×≠×≠×≠×\033[0m"
echo ""

# Start Installation
echo -ne "\033[1;36mGENERATE FREE KEY [Y/N]: \033[1;37m"
read x
[[ $x =~ ^[nN]$ ]] && exit

echo -e "\033[1;36mSelect your VPS Architecture: \033[1;37m"
echo -e "[1] - x86_64 (Standard)"
echo -e "[2] - aarch64 (ARM)"
echo -ne "\033[1;36mOption: \033[1;37m"
read respuesta

# Common Settings
sed -i 's/Port 22222/Port 22/g' /etc/ssh/sshd_config >/dev/null 2>&1
systemctl restart ssh >/dev/null 2>&1

if [[ "$respuesta" = '1' ]]; then
    mkdir /etc/rec >/dev/null 2>&1
    echo -e "\n\033[1;36mVERIFYING... \033[0m"
    rm $_Ink/list >/dev/null 2>&1
    wget -P $_Ink https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/refs/heads/main/Install/list >/dev/null 2>&1
    verif_key
elif [[ "$respuesta" = '2' ]]; then
    echo -e "\n\033[1;36mVERIFYING ARM... \033[0m"
    rm $_Ink/listARM >/dev/null 2>&1
    wget -P $_Ink https://www.dropbox.com/s/cs5poyigwm97dyd/listARM >/dev/null 2>&1
    verif_key2
else
    echo -e "\033[1;31mInvalid option!\033[0m"
    exit 1
fi

# Download Core Files
echo "/bin/menu" >/bin/h && chmod +x /bin/h >/dev/null 2>&1
rm versao* >/dev/null 2>&1
wget https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/refs/heads/main/Install/versao >/dev/null 2>&1
cd /bin/ >/dev/null 2>&1
rm v2raymanager >/dev/null 2>&1
wget https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/refs/heads/main/Modulos/v2raymanager >/dev/null 2>&1
chmod 777 v2raymanager >/dev/null 2>&1
cd $HOME

# Database Check
echo -e "\n\033[1;32mKEY VALID!\033[0m"
if [[ -f "$HOME/usuarios.db" ]]; then
    clear
    echo -e "\033[0;34m═════════════════════════════════════════════════\033[0m"
    echo -e "\n \033[1;31mATTENTION \n"
    echo -e "\033[1;33mAn existing database (usuarios.db) was found."
    echo -e "Do you want to keep existing users?\033[0m"
    echo -e "\n\033[1;37m[\033[1;31m1\033[1;37m] \033[1;33mKeep Current Database\033[0m"
    echo -e "\033[1;37m[\033[1;31m2\033[1;37m] \033[1;33mCreate New Database\033[0m"
    read -p "Option [1-2]: " -e -i 1 optiondb
fi

[[ "$optiondb" = '2' || ! -f "$HOME/usuarios.db" ]] && awk -F : '$3 >= 500 { print $1 " 1" }' /etc/passwd | grep -v '^nobody' >$HOME/usuarios.db

clear
tput setaf 7; tput setab 4; tput bold
printf '%35s%s%-18s\n' " PLEASE WAIT - INSTALLING "
tput sgr0
echo -e "\n \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mUPDATING SYSTEM \033[1;33m[\033[1;31m!\033[1;33m]\033[0m"

fun_attlist() {
    apt-get update -y
    [[ ! -d /usr/share/.plus ]] && mkdir /usr/share/.plus
}
fun_bar 'fun_attlist'

echo -e "\n \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mINSTALLING PACKAGES \033[1;33m[\033[1;31m!\033[1;33m] \033[0m"
inst_pct() {
    _pacotes=("bc" "screen" "nano" "unzip" "lsof" "net-tools" "dos2unix" "nload" "jq" "curl" "figlet" "python3" "at")
    for _prog in ${_pacotes[@]}; do
        apt install $_prog -y
    done
}
fun_bar 'inst_pct'

# Firewall Rules
[[ -f "/usr/sbin/ufw" ]] && {
    for port in 443 80 3128 8799 8080; do ufw allow $port/tcp; done
}

echo -e "\n \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mOPTIMIZING PYTHON \033[1;33m[\033[1;31m!\033[1;33m] \033[0m"
fun_bar 'otimize_python'

# Finalizing
clear
echo -e "\n \033[1;33m • \033[1;32mINSTALLATION COMPLETED\033[1;33m • \033[0m"
echo ""
echo -e "\033[1;33mMAIN COMMAND: \033[1;32mmenu\033[0m"
echo -e "\033[1;33mTELEGRAM: \033[1;37m@SSHPLUS\033[0m"

# Cleanup
rm $HOME/Plus >/dev/null 2>&1
cat /dev/null >~/.bash_history && history -c
