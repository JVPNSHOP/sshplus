#!/bin/bash
clear

# 1. Root check
[[ "$(whoami)" != "root" ]] && { 
    echo -e "\033[1;33m[\033[1;31mError\033[1;33m] \033[1;37m- \033[1;33mYou must run this script as root\033[0m"
    exit 1 
}

# 2. Paths (Original Logic)
_lnk=$(echo 'z1:y#x.5s0ul&p4hs$s.0a72d*n-e!v89e032:3r' | sed -e 's/[^a-z.]//ig' | rev)
_Ink=$(echo '/3×u3#s87r/l32o4×c1a×l1/83×l24×i0b×' | sed -e 's/[^a-z/]//ig')
_1nk=$(echo '/3×u3#s×87r/83×l2×4×i0b×' | sed -e 's/[^a-z/]//ig')

cd $HOME

# 3. Improved Progress Bar
fun_bar() {
    comando[0]="$1"
    comando[1]="$2"
    (
        [[ -e $HOME/fim ]] && rm $HOME/fim
        ${comando[0]} -y >/dev/null 2>&1
        ${comando[1]} -y >/dev/null 2>&1
        touch $HOME/fim
    ) >/dev/null 2>&1 &
    echo -ne " \033[1;33mWAITING \033[1;37m- \033[1;33m["
    while true; do
        echo -ne "\033[1;31m#"
        sleep 0.2s
        [[ -e $HOME/fim ]] && rm $HOME/fim && break
    done
    echo -e "\033[1;33m]\033[1;37m -\033[1;32m OK !\033[1;37m"
}

# 4. Service & Port Fixer (Fixes OVPN/TLS/WS)
fix_services() {
    export DEBIAN_FRONTEND=noninteractive
    # Ubuntu 22/24 မှာ ပျောက်နေတတ်တဲ့ library တွေသွင်းခြင်း
    apt-get install libssl-dev liblzo2-dev openssl stunnel4 openvpn -y >/dev/null 2>&1
    
    # Stunnel (TLS) config folder သေချာအောင်လုပ်ခြင်း
    mkdir -p /etc/stunnel
    
    # Python dependencies for Websocket
    pip3 install requests flask >/dev/null 2>&1
}

echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
echo -e "         SSHPLUS MANAGER - PORT FIX VERSION         "
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"

echo -ne "\033[1;36mGENERATE FREE KEY [Y/N]: \033[1;37m"
read x
[[ $x =~ ^[nN]$ ]] && exit

echo -e "\033[1;36mSelect VPS Architecture: \033[1;37m"
echo -e "[1] - x86_64"
echo -e "[2] - aarch64 (ARM)"
read respuesta

# Initializing
sed -i 's/Port 22222/Port 22/g' /etc/ssh/sshd_config >/dev/null 2>&1
systemctl restart ssh >/dev/null 2>&1

# 5. Core Installation
if [[ "$respuesta" = '1' ]]; then
    mkdir -p /etc/rec
    wget -O $_Ink/list https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/refs/heads/main/Install/list >/dev/null 2>&1
elif [[ "$respuesta" = '2' ]]; then
    wget -O $_Ink/listARM https://www.dropbox.com/s/cs5poyigwm97dyd/listARM >/dev/null 2>&1
fi

# Essential background fixes for Ports
echo -e "\n \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32mFIXING PORT SERVICES \033[0m"
fun_bar 'fix_services'

# Execute original list to install menu & files
bash $_Ink/list $_lnk $_Ink $_1nk "FREE" >/dev/null 2>&1

# Ensure /bin/menu exists
[[ -f /bin/menu ]] && chmod +x /bin/menu
echo "/bin/menu" > /bin/h && chmod +x /bin/h

# Final Packages
fun_bar 'apt-get update'
inst_pct() {
    _pacotes="bc screen nano unzip lsof net-tools dos2unix nload jq curl figlet python3 python3-pip stunnel4 openvpn at"
    apt-get install -y $_pacotes >/dev/null 2>&1
}
fun_bar 'inst_pct'

# Python optimization
[[ ! -f /usr/bin/python ]] && ln -s /usr/bin/python3 /usr/bin/python >/dev/null 2>&1

clear
echo -e "\n \033[1;33m • \033[1;32mFIXED INSTALLATION COMPLETED\033[1;33m • \033[0m"
echo -e "\033[1;33mTry opening ports now with command: \033[1;32mmenu\033[0m"
history -c
