#!/bin/bash

clear

# ============================================
# SSHPLUS MANAGER INSTALLATION SCRIPT
# Compatible with: Ubuntu 20.04, 22.04, 24.04
#                 Debian 11, 12, 13
# ============================================

# Colors for output
RED='\033[1;31m'
GREEN='\033[1;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;34m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
NC='\033[0m' # No Color

# Check if running as root
if [[ $EUID -ne 0 ]]; then
    echo -e "${RED}[ERROR] This script must be run as root!${NC}"
    echo -e "${YELLOW}Use: sudo bash $0${NC}"
    exit 1
fi

# Function to print section headers
print_section() {
    echo -e "\n${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN} $1 ${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

# Function to print status
print_status() {
    if [ $? -eq 0 ]; then
        echo -e "  ${GREEN}âœ“${NC} $1"
    else
        echo -e "  ${RED}âœ—${NC} $1"
    fi
}

# Function to check OS compatibility
check_os() {
    echo -e "${YELLOW}ðŸ” Detecting operating system...${NC}"
    
    # Check if /etc/os-release exists
    if [ -f /etc/os-release ]; then
        . /etc/os-release
        OS_NAME=$ID
        OS_VERSION=$VERSION_ID
        
        echo -e "${GREEN}âœ“ System: $PRETTY_NAME${NC}"
        
        # Check for supported OS
        case "$OS_NAME" in
            ubuntu)
                if [[ "$OS_VERSION" =~ ^(20\.04|22\.04|24\.04)$ ]]; then
                    echo -e "${GREEN}âœ“ Supported Ubuntu version: $OS_VERSION${NC}"
                    return 0
                else
                    echo -e "${RED}âœ— Unsupported Ubuntu version: $OS_VERSION${NC}"
                    echo -e "${YELLOW}Supported versions: 20.04, 22.04, 24.04${NC}"
                    return 1
                fi
                ;;
            debian)
                if [[ "$OS_VERSION" =~ ^(11|12|13)$ ]]; then
                    echo -e "${GREEN}âœ“ Supported Debian version: $OS_VERSION${NC}"
                    return 0
                else
                    echo -e "${RED}âœ— Unsupported Debian version: $OS_VERSION${NC}"
                    echo -e "${YELLOW}Supported versions: 11, 12, 13${NC}"
                    return 1
                fi
                ;;
            *)
                echo -e "${RED}âœ— Unsupported OS: $OS_NAME${NC}"
                return 1
                ;;
        esac
    else
        echo -e "${RED}âœ— Cannot detect OS from /etc/os-release${NC}"
        return 1
    fi
}

# Function to check architecture
check_arch() {
    echo -e "${YELLOW}ðŸ” Detecting system architecture...${NC}"
    
    ARCH=$(uname -m)
    case $ARCH in
        x86_64)
            echo -e "${GREEN}âœ“ Architecture: x86_64 (64-bit)${NC}"
            ARCH_TYPE="x64"
            ;;
        aarch64|arm64)
            echo -e "${GREEN}âœ“ Architecture: ARM64${NC}"
            ARCH_TYPE="arm"
            ;;
        *)
            echo -e "${RED}âœ— Unsupported architecture: $ARCH${NC}"
            echo -e "${YELLOW}Manually select architecture:${NC}"
            echo -e "  1) x86_64 (64-bit Intel/AMD)"
            echo -e "  2) ARM64 (Raspberry Pi, AWS Graviton)"
            read -p "Select [1/2]: " arch_choice
            
            case $arch_choice in
                1) ARCH_TYPE="x64" ;;
                2) ARCH_TYPE="arm" ;;
                *) 
                    echo -e "${RED}Invalid choice, defaulting to x86_64${NC}"
                    ARCH_TYPE="x64"
                    ;;
            esac
            ;;
    esac
}

# Function to update system
update_system() {
    print_section "SYSTEM UPDATE"
    
    echo -e "${YELLOW}Updating package lists...${NC}"
    apt-get update -y
    print_status "Package lists updated"
    
    echo -e "${YELLOW}Upgrading installed packages...${NC}"
    apt-get upgrade -y
    print_status "System upgraded"
    
    echo -e "${YELLOW}Installing essential tools...${NC}"
    apt-get install -y curl wget git sudo ufw
    print_status "Essential tools installed"
}

# Function to install required packages
install_packages() {
    print_section "PACKAGE INSTALLATION"
    
    # Create a list of essential packages
    PACKAGES=(
        # System tools
        "build-essential" "software-properties-common" "apt-transport-https"
        "ca-certificates" "gnupg" "lsb-release" "htop" "nload" "iftop"
        "net-tools" "dnsutils" "whois" "mlocate" "tree" "zip" "unzip"
        
        # Network tools
        "iptables" "iptables-persistent" "nftables" "socat" "netcat"
        "tcpdump" "nmap" "mtr" "iperf3" "openvpn" "stunnel4"
        
        # Development
        "python3" "python3-pip" "python3-dev" "python3-venv"
        "nodejs" "npm" "git" "jq" "yq"
        
        # Utilities
        "screen" "tmux" "vim" "nano" "cron" "logrotate"
        "fail2ban" "rsync" "backupninja" "unattended-upgrades"
        
        # Monitoring
        "sysstat" "dstat" "iotop" "smartmontools" "lm-sensors"
        
        # Web servers
        "nginx" "apache2" "certbot" "python3-certbot-nginx"
    )
    
    echo -e "${YELLOW}Installing ${#PACKAGES[@]} essential packages...${NC}"
    
    # Install packages one by one to avoid getting stuck
    for package in "${PACKAGES[@]}"; do
        echo -ne "  Installing $package... "
        if apt-get install -y $package > /dev/null 2>&1; then
            echo -e "${GREEN}âœ“${NC}"
        else
            echo -e "${YELLOW}âš ${NC}"
        fi
    done
    
    # Install Python packages
    echo -e "${YELLOW}Installing Python packages...${NC}"
    pip3 install --upgrade pip
    pip3 install speedtest-cli flask requests beautifulsoup4
    
    echo -e "${GREEN}âœ“ All packages installed successfully!${NC}"
}

# Function to configure firewall
configure_firewall() {
    print_section "FIREWALL CONFIGURATION"
    
    echo -e "${YELLOW}Setting up UFW firewall...${NC}"
    
    # Disable UFW first to avoid conflicts
    ufw --force disable
    ufw --force reset
    
    # Set default policies
    ufw default deny incoming
    ufw default allow outgoing
    
    # Allow SSH first (so we don't lock ourselves out)
    ufw allow 22/tcp comment 'SSH'
    
    # Allow essential ports for SSHPlus
    ESSENTIAL_PORTS=(
        "80/tcp    # HTTP"
        "443/tcp   # HTTPS"
        "53/tcp    # DNS TCP"
        "53/udp    # DNS UDP"
        "1194/tcp  # OpenVPN"
        "1194/udp  # OpenVPN UDP"
        "3128/tcp  # Squid Proxy"
        "8080/tcp  # Web Proxy"
        "8799/tcp  # SSHPlus Panel"
        "443/udp   # QUIC/HTTP3"
        "80/udp    # HTTP UDP"
    )
    
    for port_rule in "${ESSENTIAL_PORTS[@]}"; do
        port=$(echo $port_rule | awk '{print $1}')
        comment=$(echo $port_rule | awk '{print $2}')
        ufw allow $port comment "$comment"
    done
    
    # Enable UFW
    echo "y" | ufw enable
    ufw reload
    
    echo -e "${GREEN}âœ“ Firewall configured with UFW${NC}"
    echo -e "${YELLOW}Current firewall rules:${NC}"
    ufw status numbered | head -20
}

# Function to configure SSH
configure_ssh() {
    print_section "SSH CONFIGURATION"
    
    echo -e "${YELLOW}Backing up SSH configuration...${NC}"
    cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
    
    echo -e "${YELLOW}Configuring SSH settings...${NC}"
    
    # Create a new sshd_config file
    cat > /etc/ssh/sshd_config << EOF
# SSHPlus Manager Configuration
Port 22
Protocol 2
PermitRootLogin yes
PasswordAuthentication yes
PermitEmptyPasswords no
ChallengeResponseAuthentication no
UsePAM yes
X11Forwarding yes
PrintMotd no
AcceptEnv LANG LC_*
Subsystem sftp /usr/lib/openssh/sftp-server
ClientAliveInterval 300
ClientAliveCountMax 2
MaxAuthTries 3
MaxSessions 10
LoginGraceTime 60
AllowTcpForwarding yes
GatewayPorts yes
AllowAgentForwarding yes
TCPKeepAlive yes
Compression yes
EOF
    
    # Restart SSH service
    systemctl restart ssh
    
    echo -e "${GREEN}âœ“ SSH service configured and restarted${NC}"
}

# Function to download SSHPlus files
download_sshplus() {
    print_section "SSHPLUS MANAGER SETUP"
    
    echo -e "${YELLOW}Creating necessary directories...${NC}"
    mkdir -p /usr/local/sshplus
    mkdir -p /etc/sshplus
    mkdir -p /var/log/sshplus
    
    # Download based on architecture
    if [ "$ARCH_TYPE" = "x64" ]; then
        echo -e "${YELLOW}Downloading x86_64 version...${NC}"
        
        # Main installer
        wget -q -O /usr/local/sshplus/installer.sh https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/sshplus.sh
        chmod +x /usr/local/sshplus/installer.sh
        
        # Menu system
        wget -q -O /usr/local/bin/menu https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/menu.sh
        chmod +x /usr/local/bin/menu
        
        # V2Ray manager
        wget -q -O /usr/local/bin/v2raymanager https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Modulos/v2raymanager
        chmod +x /usr/local/bin/v2raymanager
        
    else
        echo -e "${YELLOW}Downloading ARM version...${NC}"
        
        # Main installer (ARM)
        wget -q -O /usr/local/sshplus/installer.sh https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/sshplus-arm.sh
        chmod +x /usr/local/sshplus/installer.sh
        
        # Menu system
        wget -q -O /usr/local/bin/menu https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Install/menu-arm.sh
        chmod +x /usr/local/bin/menu
        
        # V2Ray manager (ARM)
        wget -q -O /usr/local/bin/v2raymanager https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Modulos/v2raymanager-arm
        chmod +x /usr/local/bin/v2raymanager
    fi
    
    # Download common files
    echo -e "${YELLOW}Downloading common components...${NC}"
    
    # ShellBot for Telegram
    mkdir -p /root/bot
    wget -q -O /root/bot/ShellBot.sh https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Sistema/ShellBot.sh
    chmod +x /root/bot/ShellBot.sh
    
    # User database
    wget -q -O /etc/sshplus/users.db https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Database/users.db
    
    # Configuration files
    wget -q -O /etc/sshplus/config.json https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/main/Config/config.json
    
    # Create symlinks
    ln -sf /usr/local/bin/menu /bin/menu
    ln -sf /usr/local/bin/menu /bin/h
    ln -sf /usr/local/bin/v2raymanager /bin/v2ray
    
    echo -e "${GREEN}âœ“ SSHPlus files downloaded and configured${NC}"
}

# Function to create user database
create_user_db() {
    print_section "USER DATABASE SETUP"
    
    echo -e "${YELLOW}Creating user database...${NC}"
    
    # Check if user database exists
    if [ -f /etc/sshplus/users.db ]; then
        echo -e "${YELLOW}Existing user database found.${NC}"
        read -p "Keep existing database? (y/n): " keep_db
        
        if [[ $keep_db =~ ^[Yy]$ ]]; then
            echo -e "${GREEN}Keeping existing database${NC}"
            return
        fi
    fi
    
    # Create new user database
    cat > /etc/sshplus/users.db << EOF
# SSHPlus User Database
# Format: username:password:expiry_date:max_connections
# admin:admin123:2024-12-31:2
# user1:password1:2024-06-30:1
EOF
    
    # Add current system users
    awk -F: '$3 >= 1000 && $3 <= 60000 {print $1":changeme:"strftime("%Y-%m-%d", systime()+2592000)":1"}' /etc/passwd >> /etc/sshplus/users.db 2>/dev/null
    
    echo -e "${GREEN}âœ“ User database created${NC}"
}

# Function to setup monitoring
setup_monitoring() {
    print_section "MONITORING SETUP"
    
    echo -e "${YELLOW}Setting up system monitoring...${NC}"
    
    # Create monitoring script
    cat > /usr/local/bin/server-monitor << 'EOF'
#!/bin/bash
echo "=== SYSTEM MONITOR ==="
echo "Uptime: $(uptime -p)"
echo "Load: $(uptime | awk -F'load average:' '{print $2}')"
echo "Memory: $(free -h | awk '/^Mem:/ {print $3 "/" $2}')"
echo "Disk: $(df -h / | awk 'NR==2 {print $3 "/" $2 " (" $5 ")"}')"
echo "Users: $(who | wc -l) connected"
echo "======================"
EOF
    
    chmod +x /usr/local/bin/server-monitor
    
    # Create log rotation for SSHPlus
    cat > /etc/logrotate.d/sshplus << EOF
/var/log/sshplus/*.log {
    daily
    missingok
    rotate 7
    compress
    delaycompress
    notifempty
    create 640 root adm
    sharedscripts
    postrotate
        systemctl reload sshplus > /dev/null 2>&1 || true
    endscript
}
EOF
    
    echo -e "${GREEN}âœ“ Monitoring setup completed${NC}"
}

# Function to finalize installation
finalize_installation() {
    print_section "FINALIZING INSTALLATION"
    
    echo -e "${YELLOW}Setting up auto-start services...${NC}"
    
    # Create SSHPlus service
    cat > /etc/systemd/system/sshplus.service << EOF
[Unit]
Description=SSHPlus Manager Service
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/sshplus/installer.sh start
ExecStop=/usr/local/sshplus/installer.sh stop
Restart=always
User=root

[Install]
WantedBy=multi-user.target
EOF
    
    # Enable services
    systemctl daemon-reload
    systemctl enable sshplus
    systemctl enable ssh
    systemctl enable ufw
    
    # Create motd banner
    cat > /etc/motd << EOF
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘     SSHPLUS MANAGER - INSTALLED          â•‘
â•‘     System: $(lsb_release -ds)           â•‘
â•‘     IP: $(curl -s ifconfig.me)           â•‘
â•‘     Date: $(date)                        â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Use 'menu' command to access SSHPlus Manager
EOF
    
    # Cleanup temporary files
    apt-get autoremove -y
    apt-get clean
    
    echo -e "${GREEN}âœ“ Installation finalized${NC}"
}

# Function to show installation summary
show_summary() {
    clear
    
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}      SSHPLUS MANAGER INSTALLATION COMPLETE      ${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    echo -e "${WHITE}System Information:${NC}"
    echo -e "  OS: $(lsb_release -ds)"
    echo -e "  Kernel: $(uname -r)"
    echo -e "  Architecture: $(uname -m)"
    echo -e "  IP Address: $(curl -s ifconfig.me)"
    echo ""
    
    echo -e "${WHITE}Services Installed:${NC}"
    echo -e "  ${GREEN}âœ“${NC} SSH Server (Port 22)"
    echo -e "  ${GREEN}âœ“${NC} Firewall (UFW)"
    echo -e "  ${GREEN}âœ“${NC} SSHPlus Manager"
    echo -e "  ${GREEN}âœ“${NC} V2Ray Manager"
    echo ""
    
    echo -e "${WHITE}Ports Opened:${NC}"
    echo -e "  ${YELLOW}22${NC}   - SSH"
    echo -e "  ${YELLOW}80${NC}   - HTTP"
    echo -e "  ${YELLOW}443${NC}  - HTTPS"
    echo -e "  ${YELLOW}3128${NC} - Proxy"
    echo -e "  ${YELLOW}8799${NC} - Panel"
    echo -e "  ${YELLOW}8080${NC} - Web"
    echo ""
    
    echo -e "${WHITE}Available Commands:${NC}"
    echo -e "  ${CYAN}menu${NC}       - Main SSHPlus menu"
    echo -e "  ${CYAN}h${NC}         - Quick menu access"
    echo -e "  ${CYAN}v2ray${NC}     - V2Ray manager"
    echo -e "  ${CYAN}server-monitor${NC} - System status"
    echo ""
    
    echo -e "${WHITE}Quick Start:${NC}"
    echo -e "  1. Type ${CYAN}'menu'${NC} to open control panel"
    echo -e "  2. Create user accounts"
    echo -e "  3. Configure services"
    echo -e "  4. Monitor system usage"
    echo ""
    
    echo -e "${YELLOW}Important:${NC}"
    echo -e "  - Change default passwords"
    echo -e "  - Enable automatic updates"
    echo -e "  - Regular backups recommended"
    echo ""
    
    echo -e "${GREEN}Installation completed successfully!${NC}"
    echo -e "${CYAN}Support: Telegram @SSHPLUS${NC}"
    echo ""
}

# Main installation process
main() {
    # Display banner
    clear
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${GREEN}       SSHPLUS MANAGER INSTALLATION SCRIPT       ${NC}"
    echo -e "${YELLOW}   Compatible: Ubuntu 20/22/24 & Debian 11/12/13 ${NC}"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo ""
    
    # Check OS compatibility
    if ! check_os; then
        echo -e "${RED}This OS is not supported. Exiting.${NC}"
        exit 1
    fi
    
    # Check architecture
    check_arch
    
    # Confirm installation
    echo -e "\n${YELLOW}This script will install SSHPlus Manager with:${NC}"
    echo -e "  - System updates and packages"
    echo -e "  - Firewall configuration"
    echo -e "  - SSH optimization"
    echo -e "  - Monitoring tools"
    echo -e "  - SSHPlus Manager panel"
    echo ""
    read -p "Continue with installation? (y/n): " confirm
    
    if [[ ! $confirm =~ ^[Yy]$ ]]; then
        echo -e "${RED}Installation cancelled.${NC}"
        exit 0
    fi
    
    # Start installation
    echo -e "\n${GREEN}Starting installation process...${NC}"
    
    # Step 1: Update system
    update_system
    
    # Step 2: Install packages
    install_packages
    
    # Step 3: Configure firewall
    configure_firewall
    
    # Step 4: Configure SSH
    configure_ssh
    
    # Step 5: Download SSHPlus
    download_sshplus
    
    # Step 6: Create user database
    create_user_db
    
    # Step 7: Setup monitoring
    setup_monitoring
    
    # Step 8: Finalize installation
    finalize_installation
    
    # Show summary
    show_summary
    
    # Cleanup
    rm -f /root/install.sh
    history -c
    
    # Restart services
    systemctl restart ssh
    systemctl restart sshplus 2>/dev/null || true
    
    echo -e "\n${YELLOW}Please reboot your server for all changes to take effect.${NC}"
    echo -e "${YELLOW}Use: ${WHITE}reboot${NC}\n"
}

# Run main function
main "$@"
