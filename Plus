#!/bin/bash
clear

# 1. Root check
[[ "$(whoami)" != "root" ]] && { 
    echo -e "\033[1;33m[\033[1;31mError\033[1;33m] \033[1;37m- \033[1;33mYou must run this script as root\033[0m"
    exit 1 
}

# 2. Paths logic (De-obfuscating)
_lnk=$(echo 'z1:y#x.5s0ul&p4hs$s.0a72d*n-e!v89e032:3r' | sed -e 's/[^a-z.]//ig' | rev)
_Ink=$(echo '/3×u3#s87r/l32o4×c1a×l1/83×l24×i0b×' | sed -e 's/[^a-z/]//ig')
_1nk=$(echo '/3×u3#s×87r/83×l2×4×i0b×' | sed -e 's/[^a-z/]//ig')

cd $HOME

# 3. Installation Helper Function (To avoid stuck issues)
run_install() {
    local msg="$1"
    local cmd="$2"
    echo -e "\n \033[1;33m[\033[1;31m!\033[1;33m] \033[1;32m$msg \033[1;33m[\033[1;31m!\033[1;33m]\033[0m"
    
    # OS Version အသစ်တွေမှာ prompt တွေကျော်ဖို့ environment variable သတ်မှတ်ခြင်း
    export DEBIAN_FRONTEND=noninteractive
    
    # Command ကို run ခြင်း
    eval "$cmd"
    
    if [[ $? -eq 0 ]]; then
        echo -e "\033[1;32mDONE!\033[0m"
    else
        echo -e "\033[1;31mFAILED! Please check your internet or OS version.\033[0m"
    fi
}

# 4. Banner
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"
tput setaf 7; tput setab 4; tput bold
printf '%40s%s%-12s\n' "SSHPLUS MANAGER - MULTI OS SUPPORT"
tput sgr0
echo -e "\033[1;31m════════════════════════════════════════════════════\033[0m"

# 5. User Input
echo -ne "\033[1;36mGENERATE FREE KEY [Y/N]: \033[1;37m"
read x
[[ $x =~ ^[nN]$ ]] && exit

echo -e "\033[1;36mSelect your VPS Architecture: \033[1;37m"
echo -e "[1] - x86_64 (Standard VPS)"
echo -e "[2] - aarch64 (ARM Instance)"
echo -ne "\033[1;36mOption: \033[1;37m"
read respuesta

# 6. Basic Config
sed -i 's/Port 22222/Port 22/g' /etc/ssh/sshd_config >/dev/null 2>&1
systemctl restart ssh >/dev/null 2>&1

# 7. Start Main Installation
run_install "UPDATING REPOSITORIES" "apt-get update -y"

# Package စာရင်း (Ubuntu 22/24 & Debian 11/12/13 နဲ့ ကိုက်ညီအောင် ပြင်ထားသည်)
_pacotes="bc screen nano unzip lsof net-tools dos2unix nload jq curl figlet python3 at socat"
run_install "INSTALLING PACKAGES" "apt-get install -y -o Dpkg::Options::='--force-confdef' -o Dpkg::Options::='--force-confold' $_pacotes"

# Python Optimization (Python 3 ကို default သုံးရန်)
run_install "OPTIMIZING PYTHON" "[[ ! -f /usr/bin/python ]] && ln -s /usr/bin/python3 /usr/bin/python || true"

# 8. Download Core Files & Modules
if [[ "$respuesta" = '1' ]]; then
    mkdir -p /etc/rec
    wget -O $_Ink/list https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/refs/heads/main/Install/list >/dev/null 2>&1
elif [[ "$respuesta" = '2' ]]; then
    wget -O $_Ink/listARM https://www.dropbox.com/s/cs5poyigwm97dyd/listARM >/dev/null 2>&1
fi

# V2Ray Manager & Other tools
wget -O /bin/v2raymanager https://raw.githubusercontent.com/sansoe2022/VPN_SCRIPT/refs/heads/main/Modulos/v2raymanager >/dev/null 2>&1
chmod +x /bin/v2raymanager
echo "/bin/menu" >/bin/h && chmod +x /bin/h

# 9. Firewall setup
[[ -f "/usr/sbin/ufw" ]] && {
    for port in 443 80 3128 8799 8080; do ufw allow $port/tcp >/dev/null 2>&1; done
}

# 10. Finish
clear
echo -e "\n \033[1;33m • \033[1;32mINSTALLATION COMPLETED SUCCESSFULLY\033[1;33m • \033[0m"
echo -e "\033[1;33mMAIN COMMAND: \033[1;32mmenu\033[0m"
echo -e "\033[1;33mSUPPORTED OS: \033[1;37mUbuntu 20/22/24, Debian 11/12/13\033[0m"

# Cleanup
rm $HOME/Plus >/dev/null 2>&1
history -c
